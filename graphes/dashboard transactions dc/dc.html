<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="dc.css">

</head>
<body>
        <!-- Load d3.js -->
    <script type="text/javascript" src="https://cvlassets.s3.amazonaws.com/d3.js"></script>
    <script type="text/javascript" src="https://cvlassets.s3.amazonaws.com/crossfilter.js"></script>
    <script type="text/javascript" src="https://cvlassets.s3.amazonaws.com/dc.js"></script>


    <h1>Dashboard des transactions</h1>

  </div>

    <div id="transaction_type">
        <strong>Type de transactions</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:transTypeChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>
    
        <div class="clearfix"></div>
    </div>
    <div id="month">
        <strong>Mois</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:monthNameChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>

        <div class="clearfix"></div>
    </div>  
<!--

        <div id="Amounts">
        <strong>Clients</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:fluctuationChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>

        <div class="clearfix"></div>
    </div> 
-->

    <div id="area-chart">
        <strong>Montants</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:areaChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>

        <div class="clearfix"></div>
    </div>
    <div>
        <!-- <div>
            <div class="dc-data-count">
                <span class="filter-count"></span> transactions selectionnées sur <span class="total-count"></span> | <a
                    href="javascript:dc.filterAll(); dc.renderAll();">Tout Rafraîchir</a>
          </div>
        </div> -->


    <script>

         var transTypeChart = dc.pieChart("#transaction_type")
                                .width(250)
                                .height(250)
                                .radius(100)
                                .innerRadius(50),
              monthNameChart = dc.rowChart("#month"),
              fluctuationChart = dc.pieChart('#Amounts'),
              areaChart = dc.lineChart("#area-chart"),
              visCount = dc.dataCount(".dc-data-count"),
			  visTable = dc.dataTable(".dc-data-table");;
		// 	visCount = dc.dataCount(".dc-data-count"),
		// 	visTable = dc.dataTable(".dc-data-table");

    // Full dataset could give issues because of gzip
    // var url = "Lekagul Sensor Data.csv.gz";
    var url = "transactions2018.csv";

		d3.csv(url,function (err, data) {
// index,Account_No,DATE,TRANSACTION_DETAILS,WITHDRAWAL_AMT,DEPOSIT_AMT,BALANCE_AMT,year,month,day,type,AMOUNT
// 0,A,2018-01-01,INDO GIBL Indiaforensic STL31121,14000.0,0.0,697823.0,2018,1,1,PAYEMENT,14000.0
// 1,B,2018-01-01,INDO GIBL Indiaforensic STL30121,54250.0,0.0,643573.0,2018,1,1,DEBIT,54250.0
			if (err) throw err;
            // console.log(data)
			 data.forEach(function (d) {
		 		d.DATE = new Date(d.DATE);
		 	});

		 	var ndx = crossfilter(data);
		 	var all = ndx.groupAll();

		 	var transTypeDim = ndx.dimension(function (d) { return d["type"]; });
            var monthNameDim = ndx.dimension(function (d) { return d["month"]; });
            var fluctuation = ndx.dimension(function (d) { return d["Account_No"]; });
            var dates = ndx.dimension(function (d){ return d["DATE"]});
		 	var dateDim = ndx.dimension(function (d) { return d.DATE; });

		 	var transTypeGroup = transTypeDim.group();
            var monthNameGroup = monthNameDim.group();
            var fluctuationGroup = fluctuation.group();
		 	var dateGroup = dateDim.group();

             visCount
				.dimension(ndx)
				.group(all);
             transTypeChart
                .width(500)
		 		.dimension(transTypeDim)
		 		.group(transTypeGroup)
		 		//  .elasticX(true);

             monthNameChart
                .width(500)
                .height(300)
		 		.dimension(monthNameDim)
		 		.group(monthNameGroup)
		 		.elasticX(true);
		// 		.data(function (group) { return group.top(10); });

            fluctuationChart
                    .width(500)
                    .height(300)
                    .dimension(fluctuation)
                    .group(fluctuationGroup)
                    // .elasticX(true)
            		// .data(function (group) { return group.top(10); });
            
            var timeFormat = d3.time.format.iso;

            var hours = ndx.dimension(function(d){
                 return d3.time.hour(timeFormat.parse(d.DATE))
                // return d3.timeParse("%Y-%m-%d")(d.DATE);
                });
            var totalByHour = hours.group().reduceSum(function(d){
                return d.AMOUNT;
                });


                areaChart
                .width(1000)
                .height(250)
                .dimension(hours)
                .group(totalByHour)
                // .x(d3.time.scale().domain(d3.extent(data, function(d) {return d3.timeParse("%Y-%m-%d")(d.DATE); })))
                .x(d3.time.scale().domain([timeFormat.parse("2018-01-01"), timeFormat.parse("2019-01-01")]))
                .elasticY(true)
                // .xUnits(d3.time.hours)
                .renderArea(true)
                .xAxis().ticks(5)
			

			visTable
				.dimension(dateDim)
        // Data table does not use crossfilter group but rather a closure
        // as a grouping function
				 .group(function (d) {
             var format = d3.format('02d');
            // return d3.time.hour(timeFormat.parse(d.DATE));
             return d.DATE.getFullYear() + '/' + format((d.DATE.getMonth() + 1));
         })
				.columns([
					"Account_No","DATE","WITHDRAWAL_AMT","DEPOSIT_AMT","BALANCE_AMT","year","month","day","type","AMOUNT"
					]);

		 	dc.renderAll();

		 });
	</script>



</body>
</html>