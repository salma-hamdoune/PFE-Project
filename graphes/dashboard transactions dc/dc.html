<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="dc.css">

</head>
<body>
        <!-- Load d3.js -->
    <script type="text/javascript" src="https://cvlassets.s3.amazonaws.com/d3.js"></script>
    <script type="text/javascript" src="https://cvlassets.s3.amazonaws.com/crossfilter.js"></script>
    <script type="text/javascript" src="https://cvlassets.s3.amazonaws.com/dc.js"></script>
    
    <!-- <script src="https://unpkg.com/d3@5/dist/d3.js"></script>
    <script src="https://unpkg.com/crossfilter2@1.4/crossfilter.js"></script>
    <script src="https://unpkg.com/dc@3/dc.js"></script> -->


    <h1>Dashboard des transactions</h1>
    <div class="tool radius">
        <h5 class="text-uppercase">Client</h5>
        <select class="form-control" id="clients"></select>
    </div>
    <!-- <div class="tool radius">
        <h5 class="text-uppercase">Day</h5>
        <select class="form-control" id="days"></select>
    </div> -->
    
  </div>

    <div id="transaction_type">
        <strong>Types des transactions</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:transTypeChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>
    
        <div class="clearfix"></div>
    </div>


    <div id="month">
        <strong>Nombre de transactions par mois</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:monthNameChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>

        <div class="clearfix"></div>
    </div> 

    <div id="receiver">
        <strong>Nombre de transactions faites avec chaque compte (Top 10)</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:receiverChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>

        <div class="clearfix"></div>
    </div>
    
    
    <div id="receiver_amount">
        <strong>Montants de transactions réalisées avec chaque compte (Top 10)</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:receiverAmountChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>

        <div class="clearfix"></div>
    </div> 

 
<!--

        <div id="Amounts">
        <strong>Clients</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:fluctuationChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>

        <div class="clearfix"></div>
    </div> 
-->

    <div id="area-chart">
        <strong>Montants journaliers des transactions</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:areaChart.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>

        <div class="clearfix"></div>
    </div>
    <div id="area-chart-bal">
        <strong>Fluctuations journalières du solde (Dépôts - Retraits)</strong>
        <span class="reset" style="display: none;">Selectionné: <span class="filter"></span></span>
        <a class="reset" href="javascript:areaChartBal.filterAll();dc.redrawAll();" style="display: none;">Rafraîchir</a>

        <div class="clearfix"></div>
    </div>
    <div>
        <!-- <div>
            <div class="dc-data-count">
                <span class="filter-count"></span> transactions selectionnées sur <span class="total-count"></span> | <a
                    href="javascript:dc.filterAll(); dc.renderAll();">Tout Rafraîchir</a>
          </div>
        </div> -->


    <script>

         var transTypeChart = dc.pieChart("#transaction_type")
                                .width(250)
                                .height(250)
                                .radius(100)
                                .innerRadius(50),
              monthNameChart = dc.rowChart("#month"),
            //   fluctuationChart = dc.pieChart('#Amounts'),
              areaChart = dc.lineChart("#area-chart"),
              areaChartBal = dc.lineChart("#area-chart-bal"),
            //   visCount = dc.dataCount(".dc-data-count"),
			//   visTable = dc.dataTable(".dc-data-table")
                receiverAmountChart=dc.rowChart("#receiver_amount"),
                receiverChart=dc.rowChart("#receiver");

		// 	visCount = dc.dataCount(".dc-data-count"),
		// 	visTable = dc.dataTable(".dc-data-table");

    // Full dataset could give issues because of gzip
    // var url = "Lekagul Sensor Data.csv.gz";
    var url = "transactions2018.csv";

		d3.csv(url,function (err, data) {
// index,Account_No,DATE,TRANSACTION_DETAILS,WITHDRAWAL_AMT,DEPOSIT_AMT,BALANCE_AMT,year,month,day,type,AMOUNT
// 0,A,2018-01-01,INDO GIBL Indiaforensic STL31121,14000.0,0.0,697823.0,2018,1,1,PAYEMENT,14000.0
// 1,B,2018-01-01,INDO GIBL Indiaforensic STL30121,54250.0,0.0,643573.0,2018,1,1,DEBIT,54250.0
			if (err) throw err;
            // console.log(data)
			 data.forEach(function (d) {
		 		d.DATE = new Date(d.DATE);
		 	});

		 	var ndx = crossfilter(data);
		 	var all = ndx.groupAll();

		 	var transTypeDim = ndx.dimension(function (d) { return d["type"]; });
            var monthNameDim = ndx.dimension(function (d) { return d["month"]; });
            var clients = ndx.dimension(function (d) { return d["Account_No"]; });
            var days = ndx.dimension(function (d) { return d["day"]; });

            // var dates = ndx.dimension(function (d){ return d["DATE"]});
		 	var dateDim = ndx.dimension(function (d) { return d.DATE; });
            var exptDim = ndx.dimension(function(d) {return d.Account_No;});
            var balDim = ndx.dimension(function(d) {return d.BALANCE_AMT;});
            var receiverDim = ndx.dimension(function(d) {return d.receiver_Account;});


		 	var transTypeGroup = transTypeDim.group();
            var monthNameGroup = monthNameDim.group();
            var clientsGroup = clients.group();
            var daysGroup = days.group();
		 	var dateGroup = dateDim.group();
            var exptGroup = exptDim.group();
            // var balGroup = balDim.group().reduceSum(function(d) {return d.index;});
            var receiverGroup = receiverDim.group();


            // Client Selector
            var client_default = "A"; // default client in the selection drop down

		    // drop down selection
		    var selector = d3.select("#clients");
            // console.log(clientsGroup.all());
            
            // append option values to clients select input
            selector.selectAll("option")
                .data(clientsGroup.all())
                .enter()
                .append("option")
                .attr("value", function(d) {
                    return d.key;
                })
                .text(function(d) {
                    return d.key;
                });
		
		    // set default client
		    // define on change event
		     selector.property("value", client_default).on("change", function() { clients.filter(this.value); dc.redrawAll(); });
             clients.filter(client_default);

           
            // day Selector

            var day_default = "1"; // default day in the selection drop down

            // drop down selection
            var selector = d3.select("#days");
            // console.log(daysGroup.all());
             // append option values to days select input
            selector.selectAll("option")
                .data(daysGroup.all())
                .enter()
                .append("option")
                .attr("value", function(d) {
                    return d.key;
                })
                .text(function(d) {
                    return d.key;
                });
            // set default day
		    // define on change event
            // selector.property("value", day_default).on("change", function() { days.filter(this.value); dc.redrawAll(); });
            //  days.filter(day_default);
            //  visCount
			// 	.dimension(ndx)
			// 	.group(all);

            // Transactions types Chart

             transTypeChart
                .width(500)
		 		.dimension(transTypeDim)
		 		.group(transTypeGroup)
		 		//  .elasticX(true);


            // Months Chart

             monthNameChart
                .width(500)
                .height(300)
		 		.dimension(monthNameDim)
		 		.group(monthNameGroup)
		 		.elasticX(true);
		// 		.data(function (group) { return group.top(10); });

        function getTops(source_group) {
            return {
            all: function () {
                return source_group.top(10);
                }
            };
        }
var fakeGroup = getTops(receiverGroup);
        
            // Receivers Chart
            console.log(receiverChart)
            receiverChart
                .height(300)
                .width(500)
		 		.dimension(receiverDim)
		 		.group(fakeGroup)
		 	    .elasticX(true)
                // .filter(function (group) { return group.top(10); });
            
            
            // Receivers amounts Chart
            var amountbyreceiver = receiverDim.group().reduceSum(function(d){
                return d.AMOUNT;
                });
            var topreceiverAmounts = getTops(amountbyreceiver);

            receiverAmountChart
                .height(300)
                .width(500)
		 		.dimension(receiverDim)
		 		.group(topreceiverAmounts)
		 	    .elasticX(true)



            // fluctuationChart
            //         .width(500)
            //         .height(300)
            //         .dimension(fluctuation)
            //         .group(fluctuationGroup)
                    // .elasticX(true)
            		// .data(function (group) { return group.top(10); });


             // Amounts Chart
    
            var timeFormat = d3.time.format.iso;

            var hours = ndx.dimension(function(d){
                 return d3.time.hour(timeFormat.parse(d.DATE))
                // return d3.timeParse("%Y-%m-%d")(d.DATE);
                });
            var totalByHour = hours.group().reduceSum(function(d){
                return d.AMOUNT;
                });
            // console.log(hours.group());
            
            areaChart
                .width(1000)
                .height(250)
                .dimension(hours)
                .group(totalByHour)
                // .x(d3.time.scale().domain(d3.extent(data, function(d) {return d3.timeParse("%Y-%m-%d")(d.DATE); })))
                .x(d3.time.scale().domain([timeFormat.parse("2018-01-01"), timeFormat.parse("2019-01-01")]))
                .elasticY(true)
                // .xUnits(d3.time.hours)
                .renderArea(true)
                .xAxis().ticks(5)
                areaChart.margins().left = 80

            // Balance Chart

            var totalbalByHour = hours.group().reduceSum(function(d){
                return d.DEPOSIT_AMT - d.WITHDRAWAL_AMT;
                });
            areaChartBal
                .width(1000)
                .height(250)
                .dimension(hours)
                .group(totalbalByHour)
                // .x(d3.time.scale().domain(d3.extent(data, function(d) {return d3.timeParse("%Y-%m-%d")(d.DATE); })))
                .x(d3.time.scale().domain([timeFormat.parse("2018-01-01"), timeFormat.parse("2019-01-01")]))
                .elasticY(true)
                // .xUnits(d3.time.hours)
                .renderArea(true)
                .xAxis().ticks(5)
                areaChartBal.margins().left = 80;



		 	dc.renderAll();

		 });
	</script>



</body>
</html>